{"version":3,"sources":["resources/js/app.js"],"names":["CaptureService","prototype","set","canvas","this","snapshot","service","queue","promise","Promise","resolve","reject","snapshotRender","url","toDataURL","bytes","atob","slice","buffer","Uint8Array","length","i","charCodeAt","blob","Blob","type","extension","record","window","MediaRecorder","captureStream","console","log","capture","chunks","stream","options","mimeType","recorder","ondataavailable","e","data","size","push","tracks","getTracks","forEach","track","stop","removeTrack","start","Parser","tuple","array","keys","2","3","4","r","filter","v","enumerate","prefix","getter","key","obj","p","Array","isArray","undefined","get","Object","map","GuiService","callback","closed","hidden","pool","copy","JSON","parse","stringify","load","params","gui","locals","changed","a","b","destroy","dat","GUI","hide","show","_merge","hasOwnProperty","merge","_callback","loop","value","add","onChange","folder","addFolder","randomize","_randomize","__controllers","c","initialValue","__min","__max","Math","random","property","updateDisplay","f","__folders","domElement","style","display","uniforms","onGlslError","message","errors","warnings","error","replace","m","l","t","li","encodeURI","uri","Number","output","join","document","querySelector","setAttribute","innerHTML","addEventListener","stats","statsdom","content","buttons","pause","create","flags","toggle","resize","glsl","GlslCanvas","premultipliedAlpha","preserveDrawingBuffer","backgroundColor","on","ri","setUniforms","o","vertex","trim","fragment","textures","setUniform","init","w","offsetWidth","h","offsetHeight","width","height","togglePause","paused","timePause","timePrev","Date","timeLoad","play","forceRender","render","then","video","URL","createObjectURL","link","createElement","href","download","click","setTimeout","revokeObjectURL","visibility","Stats","showPanel","dom","body","appendChild","requestAnimationFrame","statsTick","update","parent","postMessage","command","event","clearTimeout"],"mappings":"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","file":"app.min.js","sourcesContent":["/* global window, document, console, GlslCanvas */\n/* \nAuthor: Brett Camper (@professorlemeza)\nURL: https://github.com/tangrams/tangram/blob/master/src/utils/media_capture.js\n*/\n\n(function () {\n    'use strict';\n\n    function CaptureService() {}\n\n    CaptureService.prototype = {\n        set: set,\n        snapshot: snapshot,\n        snapshotRender: snapshotRender,\n        record: record,\n        stop: stop,\n    };\n\n    function set(canvas) {\n        var service = this;\n        service.canvas = canvas;\n    }\n\n    /*\n    var mimeTypes = [\n        'video/webm\\;codecs=h264',\n        'video/webm\\;codecs=vp8',\n        'video/webm\\;codecs=daala',\n        'video/webm',\n        'audio/webm\\;codecs=opus',\n        'audio/webm',\n        'video/mpeg',\n    ];\n    var options = {\n        videoBitsPerSecond: 2500000,\n        audioBitsPerSecond: 128000,\n        mimeType: 'video/webm',\n        extension: '.webm',\n    };\n    // MediaRecorder.isTypeSupported(mimeTypes[0])\n    */\n\n    function record() {\n        var service = this;\n        if (typeof window.MediaRecorder !== 'function' || !service.canvas || typeof service.canvas.captureStream !== 'function') {\n            console.log('warn: Video capture (Canvas.captureStream and/or MediaRecorder APIs) not supported by browser');\n            return false;\n        } else if (service.capture) {\n            console.log('warn: Video capture already in progress, call Scene.stopVideoCapture() first');\n            return false;\n        }\n        try {\n            var capture = {};\n            var chunks = [];\n            var stream = service.canvas.captureStream();\n            var options = {\n                mimeType: 'video/webm', // 'video/webm\\;codecs=h264'\n            };\n            var recorder = new MediaRecorder(stream, options);\n            recorder.ondataavailable = function (e) {\n                if (e.data.size > 0) {\n                    chunks.push(e.data);\n                }\n                // Stopped recording? Create the final capture file blob\n                if (capture.resolve) {\n                    var blob = new Blob(chunks, {\n                        type: options.mimeType,\n                    });\n                    if (stream) {\n                        var tracks = stream.getTracks() || [];\n                        tracks.forEach(function (track) {\n                            track.stop();\n                            stream.removeTrack(track);\n                        });\n                    }\n                    stream = null;\n                    service.recorder = null;\n                    service.capture = null;\n                    capture.resolve({\n                        blob: blob,\n                        extension: '.webm',\n                    });\n                }\n            };\n            service.capture = capture;\n            service.recorder = recorder;\n            recorder.start();\n        } catch (e) {\n            service.capture = null;\n            service.recorder = null;\n            console.log('error: Scene video capture failed', e);\n            return false;\n        }\n        return true;\n    }\n\n    function stop() {\n        var service = this;\n        if (!service.capture) {\n            console.log('warn: No scene video capture in progress, call Scene.startVideoCapture() first');\n            return Promise.resolve({});\n        }\n        service.capture.promise = new Promise(function (resolve, reject) {\n            service.capture.resolve = resolve;\n            service.capture.reject = reject;\n        });\n        service.recorder.stop();\n        return service.capture.promise;\n    }\n\n    function snapshot() {\n        var service = this;\n        if (service.queue) {\n            return service.queue.promise;\n        }\n        service.queue = {};\n        service.queue.promise = new Promise(function (resolve, reject) {\n            service.queue.resolve = resolve;\n            service.queue.reject = reject;\n        });\n        return service.queue.promise;\n    }\n\n    function snapshotRender() {\n        var service = this;\n        if (service.queue) {\n            // Get data URL, convert to blob\n            // Strip host/mimetype/etc., convert base64 to binary without UTF-8 mangling\n            // Adapted from: https://gist.github.com/unconed/4370822\n            var url = service.canvas.toDataURL('image/png');\n            var bytes = atob(url.slice(22));\n            var buffer = new Uint8Array(bytes.length);\n            for (var i = 0; i < bytes.length; ++i) {\n                buffer[i] = bytes.charCodeAt(i);\n            }\n            var blob = new Blob([buffer], {\n                type: 'image/png',\n            });\n            service.queue.resolve({\n                blob: blob,\n                extension: '.png',\n            });\n            service.queue = null;\n        }\n    }\n\n    window.CaptureService = CaptureService;\n}());\n/* global window, document, console */\n\n(function () {\n    'use strict';\n\n    var Parser = function () {\n\n        var Parser = {\n            set: set,\n            get: get,\n        };\n\n        function tuple(array) {\n            var tuples = {\n                2: ['x', 'y'],\n                3: ['x', 'y', 'z'],\n                4: ['r', 'g', 'b', 'a']\n            };\n            var keys = tuples[array.length];\n            var r = {};\n            array.filter(function (v, i) {\n                r[keys[i]] = v;\n            });\n            return r;\n        }\n\n        function enumerate(array, prefix) {\n            var r = {};\n            array.filter(function (v, i) {\n                r[prefix + i] = v;\n            });\n            return r;\n        }\n\n        function getter(v) {\n            return function (key) {\n                return v[key];\n            };\n        }\n\n        function set(obj) {\n            var data = {};\n            for (var p in obj) {\n                var v = obj[p];\n                if (Array.isArray(v)) {\n                    if (v.length > 1) {\n                        switch (typeof v[0]) {\n                            case 'number':\n                                if (v.length < 5) {\n                                    data[p] = tuple(v);\n                                }\n                                break;\n                            case 'boolean':\n                                data[p] = enumerate(v, 'bool_');\n                                break;\n                            case 'string':\n                                data[p] = enumerate(v, 'texture_');\n                                break;\n                            case 'object':\n                                data[p] = enumerate(v, 'struct_');\n                                break;\n                        }\n                    } else if (v.length) {\n                        data[p] = v[0];\n                    }\n                } else if (v !== undefined && v !== null) {\n                    data[p] = v;\n                }\n            }\n            return data;\n        }\n\n        function get(obj) {\n            var data = {};\n            for (var p in obj) {\n                var v = obj[p];\n                switch (typeof v) {\n                    case 'function':\n                        break;\n                    case 'number':\n                    case 'boolean':\n                    case 'string':\n                        data[p] = v;\n                        break;\n                    default:\n                        var keys = Object.keys(v);\n                        data[p] = keys.map(getter(v));\n                        break;\n                }\n            }\n            // console.log('Parser.get', data);\n            return data;\n        }\n\n        /*\n        float                                   <--- typeof U === 'number'\n        bool                                    <--- typeof U === 'boolean'\n        sampler2D                               <--- typeof U === 'string'\n        Structure                               <--- typeof U === 'object'\n        ARRAYS of                               <--- Array.isArray(U)\n            number                              <--- typeof U[0] === 'number'\n                float                           <--- U.length === 1\n                vec2, vec3, vec4                <--- U.length > 1 && U.length < 5\n                float[]                         <--- U.length > 4\n            sampler2D[]                         <--- typeof U[0] === 'string'\n            vec2[], vec3[], vec4[]              <--- Array.isArray(U[0]) && typeof U[0][0] === 'number'\n            Structure[]                         <--- typeof U[0] === 'object'\n        \n            TODO: assume matrix for (typeof == Float32Array && length == 16)\n        TODO: support other non-float types? (int, etc.)\n        */\n\n        return Parser;\n\n    }();\n\n    var GuiService = function () {\n\n        function GuiService(callback) {\n            this.closed = true;\n            this.hidden = true;\n            this.callback = callback || function () {\n                console.log('GuiService.onChange');\n            };\n            this.pool = {};\n        }\n\n        GuiService.prototype = {\n            load: load,\n            hide: hide,\n            show: show,\n            uniforms: uniforms,\n        };\n\n        // statics\n\n        function differs(a, b) {\n            // console.log('differs', JSON.stringify(a), JSON.stringify(b));\n            return JSON.stringify(a) !== JSON.stringify(b);\n        }\n\n        function copy(obj) {\n            return JSON.parse(JSON.stringify(obj));\n        }\n\n        function merge(a, b) {\n            function _merge(a, b) {\n                for (var key in a) {\n                    if (b.hasOwnProperty(key)) {\n                        if (typeof a[key] === 'number') {\n                            a[key] = b[key];\n                        } else if (typeof a[key] == 'object' && Object.keys(a[key]).length > 0) {\n                            _merge(a[key], b[key]);\n                        }\n                    }\n                }\n            }\n            if (a) {\n                a = copy(a);\n\n                _merge(a, b);\n            }\n            return a;\n        }\n\n        function loop(obj, params, callback) {\n            var keys = [],\n                p;\n            for (p in params) {\n                keys.push(p);\n            }\n            keys.filter(function (key) {\n                var value = params[key];\n                if (typeof value === 'number') {\n                    p = obj.add(params, key, 0.0, 1.0);\n                    p.onChange(callback);\n                } else if (typeof value === 'object' && Object.keys(value).length > 0) {\n                    p = null;\n                    var folder = obj.addFolder(key);\n                    loop(folder, value, callback);\n                } else {\n                    p = obj.add(params, key);\n                    p.onChange(callback);\n                }\n            });\n        }\n\n        function randomize(obj, params, callback) {\n\n            function _randomize(obj, params) {\n                obj.__controllers.filter(function (c) {\n                    if (typeof c.initialValue === 'number' && typeof c.__min === 'number' && typeof c.__max === 'number') {\n                        var value = c.__min + (c.__max - c.__min) * Math.random();\n                        params[c.property] = value;\n                        c.updateDisplay();\n                    }\n                });\n                for (var f in obj.__folders) {\n                    _randomize(obj.__folders[f], params[f]);\n                }\n            }\n            _randomize(obj, params);\n            callback();\n        }\n\n        // publics\n\n        function load(params) {\n            var service = this;\n            var gui = service.gui;\n            var locals = service.locals;\n            var changed = differs(params, locals);\n            if (gui && changed) {\n                service.closed = gui.closed;\n                gui.destroy();\n                gui = null;\n            }\n            if (!gui) {\n                gui = new dat.GUI();\n                gui.closed = service.closed;\n                service.gui = gui;\n                if (service.hidden) {\n                    service.hide();\n                } else {\n                    service.show();\n                }\n            }\n            if (changed) {\n                locals = copy(params);\n                service.locals = locals;\n                var pool = Parser.set(params);\n                pool = merge(pool, service.pool);\n                service.pool = pool;\n                var _callback = function () {\n                    service.callback(pool);\n                };\n                loop(gui, pool, _callback);\n                pool.randomize = function () {\n                    randomize(gui, pool, _callback);\n                };\n                gui.add(pool, 'randomize');\n            }\n        }\n\n        function hide() {\n            var service = this;\n            var gui = service.gui;\n            gui.domElement.style.display = 'none';\n            service.hidden = true;\n            // dat.GUI.toggleHide();\n        }\n\n        function show() {\n            var service = this;\n            var locals = service.locals;\n            if (Object.keys(locals).length) {\n                var gui = service.gui;\n                gui.domElement.style.display = '';\n            }\n            service.hidden = false;\n        }\n\n        function uniforms() {\n            var service = this;\n            var pool = service.pool;\n            return Parser.get(pool);\n        }\n\n        return GuiService;\n    }();\n\n    window.GuiService = GuiService;\n\n}());\n/* global window, document, console, GlslCanvas, CaptureService, Stats, dat */\n\n(function () {\n    'use strict';\n\n    function onLoad() {\n        var stats, statsdom;\n\n        var content = document.querySelector('.content');\n        var canvas = document.querySelector('.shader');\n        var buttons = {\n            pause: document.querySelector('.btn-pause'),\n            record: document.querySelector('.btn-record'),\n            stats: document.querySelector('.btn-stats'),\n            create: document.querySelector('.btn-create'),\n        };\n        var flags = {\n            toggle: false,\n            record: false,\n            stats: false,\n        };\n\n        resize(true);\n\n        var glsl = new GlslCanvas(canvas, {\n            premultipliedAlpha: false,\n            preserveDrawingBuffer: true,\n            backgroundColor: 'rgba(1,1,1,1)',\n        });\n        glsl.on('error', onGlslError);\n\n        var service = new CaptureService();\n        service.set(canvas);\n\n        glsl.on('render', function () {\n            service.snapshotRender();\n        });\n\n        var gui = new GuiService(function (params) {\n            var uniforms = gui.uniforms();\n            // console.log('GuiService.onUpdate', uniforms);\n            glsl.setUniforms(uniforms);\n        });\n\n        load();\n\n        function load() {\n            document.querySelector('.errors').setAttribute('class', 'errors');\n            document.querySelector('.welcome').setAttribute('class', (options.uri ? 'welcome' : 'welcome active'));\n            var o = window.options;\n            o.vertex = o.vertex.trim().length > 0 ? o.vertex : null;\n            o.fragment = o.fragment.trim().length > 0 ? o.fragment : null;\n            glsl.load(o.fragment, o.vertex);\n            for (var t in o.textures) {\n                glsl.setUniform('u_texture_' + t, o.textures[t]);\n            }\n            gui.load(o.uniforms);\n            glsl.setUniforms(gui.uniforms());\n            document.querySelector('body').setAttribute('class', (o.fragment || o.vertex ? 'ready' : 'empty'));\n        }\n\n        function resize(init) {\n            var w = content.offsetWidth;\n            var h = content.offsetHeight;\n            canvas.style.width = w + 'px';\n            canvas.style.height = h + 'px';\n            if (init) {\n                canvas.width = w;\n                canvas.height = h;\n            } else {\n                glsl.resize();\n            }\n        }\n\n        function snapshot() {\n            glsl.forceRender = true;\n            glsl.render();\n            return service.snapshot();\n        }\n\n        function record() {\n            glsl.forceRender = true;\n            glsl.render();\n            if (service.record()) {\n                // flags.record = true;\n            }\n        }\n\n        function stop() {\n            service.stop().then(function (video) {\n                // console.log('service.stop');\n                // var filename = options.uri.path.split('/').pop().replace('.glsl', '');\n                // console.log('filename', filename);\n                var url = URL.createObjectURL(video.blob);\n                var link = document.createElement('a');\n                link.href = url;\n                link.download = 'shader' + video.extension;\n                link.click();\n                setTimeout(function () {\n                    window.URL.revokeObjectURL(output);\n                }, 100);\n            });\n        }\n\n        function togglePause() {\n            flags.pause = !flags.pause;\n            // console.log('pause', flags.pause);\n            if (glsl.paused) {\n                if (glsl.timePause) {\n                    glsl.timePrev = new Date();\n                    glsl.timeLoad += (glsl.timePrev - glsl.timePause);\n                }\n                glsl.play();\n                buttons.pause.querySelector('i').setAttribute('class', 'icon-pause');\n            } else {\n                glsl.pause();\n                glsl.timePause = new Date();\n                buttons.pause.querySelector('i').setAttribute('class', 'icon-play');\n            }\n        }\n\n        function toggleRecord() {\n            flags.record = !flags.record;\n            // console.log('record', flags.record);\n            if (flags.record) {\n                buttons.record.setAttribute('class', 'btn btn-record active');\n                buttons.record.querySelector('i').setAttribute('class', 'icon-stop');\n                record();\n            } else {\n                buttons.record.setAttribute('class', 'btn btn-record');\n                buttons.record.querySelector('i').setAttribute('class', 'icon-record');\n                stop();\n            }\n        }\n\n        function toggleStats() {\n            flags.stats = !flags.stats;\n\n            function statsTick() {\n                stats.update();\n                if (flags.stats) {\n                    requestAnimationFrame(statsTick);\n                }\n            }\n            if (flags.stats) {\n                if (!statsdom) {\n                    stats = new Stats();\n                    stats.showPanel(0); // 0: fps, 1: ms, 2: mb, 3+: custom\n                    statsdom = stats.dom;\n                    // statsdom.style.cssText = 'position:fixed;top:0;right:0;cursor:pointer;opacity:0.9;z-index:10000';\n                    document.body.appendChild(stats.dom);\n                } else {\n                    statsdom.style.visibility = 'visible';\n                }\n                requestAnimationFrame(statsTick);\n                gui.show();\n                buttons.stats.setAttribute('class', 'btn btn-stats active');\n            } else {\n                if (statsdom) {\n                    statsdom.style.visibility = 'hidden';\n                }\n                gui.hide();\n                buttons.stats.setAttribute('class', 'btn btn-stats');\n            }\n        }\n\n        function createShader(e) {\n            // console.log('createShader', e);\n            window.parent.postMessage({\n                command: \"did-click-link\",\n                data: 'command:glsl-canvas.createShader?' + JSON.stringify([options.uri]),\n            }, \"file://\");\n        }\n\n        function onMessage(event) {\n            window.options = JSON.parse(event.data);\n            // console.log('onMessage', window.options);\n            // event.source.postMessage('message', event.origin);\n            load();\n        }\n\n        var ri;\n\n        function onResize() {\n            if (ri) {\n                clearTimeout(ri);\n            }\n            ri = setTimeout(resize, 50);\n        }\n\n        canvas.addEventListener(\"dblclick\", togglePause);\n        buttons.pause.addEventListener('mousedown', togglePause);\n        buttons.record.addEventListener('mousedown', toggleRecord);\n        buttons.stats.addEventListener('mousedown', toggleStats);\n        buttons.create.addEventListener('click', createShader);\n        window.addEventListener(\"message\", onMessage, false);\n        window.addEventListener('resize', onResize);\n        resize();\n    }\n\n    function onGlslError(message) {\n        // console.log('onGlslError.error', message.error);\n        var options = window.options;\n        var errors = [],\n            warnings = [];\n        message.error.replace(/ERROR: \\d+:(\\d+): \\'(.+)\\' : (.+)/g, function (m, l, v, t) {\n            var message = 'ERROR (' + v + ') ' + t;\n            var li = '<li><a class=\"error\" unselectable href=\"' + encodeURI('command:glsl-canvas.revealGlslLine?' + JSON.stringify([options.uri, Number(l), message])) + '\"><span class=\"line\">ERROR line ' + Number(l) + '</span> <span class=\"value\" title=\"' + v + '\">' + v + '</span> <span class=\"text\" title=\"' + t + '\">' + t + '</span></a></li>';\n            errors.push(li);\n            return li;\n        });\n        message.error.replace(/WARNING: \\d+:(\\d+): \\'(.*\\n*|.*|\\n*)\\' : (.+)/g, function (m, l, v, t) {\n            var li = '<li><a class=\"warning\" unselectable href=\"' + encodeURI('command:glsl-canvas.revealGlslLine?' + JSON.stringify([options.uri, Number(l), message])) + '\"><span class=\"line\">WARN line ' + Number(l) + '</span> <span class=\"text\" title=\"' + t + '\">' + t + '</span></a></li>';\n            warnings.push(li);\n            return li;\n        });\n        var output = '<div class=\"errors-content\"><p>glslCanvas error</p><ul>';\n        output += errors.join('\\n');\n        output += warnings.join('\\n');\n        output += '</ul></div>';\n        document.querySelector('.errors').setAttribute('class', 'errors active');\n        document.querySelector('.errors').innerHTML = output;\n    }\n    window.addEventListener('load', onLoad);\n}());"]}